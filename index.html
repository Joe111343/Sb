<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Ê°É‰ø° Momo Talk</title>
<style>
  body { font-family: "Segoe UI","Microsoft JhengHei",sans-serif; margin:0; background:linear-gradient(to bottom,#ffeef3,#ffffff); display:flex; flex-direction:column; height:100vh; }
  header { background:#ff5a7e; color:white; padding:1em; text-align:center; font-weight:bold; font-size:1.3em; letter-spacing:1px; box-shadow:0 2px 4px #e47; }
  .panel { padding:1em; background:#fff; border-radius:12px; margin:1em; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .panel label { font-weight:bold; margin-right:0.5em; }
  #chat { flex:1; padding:1em; overflow-y:auto; background:#fffafc; display:flex; flex-direction:column; }
  .message { display:flex; align-items:flex-start; margin:0.6em 0; }
  .message img.avatar { width:48px; height:48px; border-radius:50%; border:2px solid #ff8ca5; margin-right:0.5em; object-fit:cover; }
  .bubble { max-width:70%; padding:0.6em 1em; border-radius:1em; word-break:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:relative; }
  .me { flex-direction:row-reverse; }
  .me img.avatar { margin-left:0.5em; margin-right:0; }
  .me .bubble { background:linear-gradient(to right,#ffbdd3,#ffdce7); margin-left:auto; }
  .you .bubble { background:#f1f1f1; }
  .audio-bubble { display:inline-block; }
  #input-area { display:flex; padding:1em; border-top:1px solid #ccc; background:#fff0f5; }
  input, button { font-size:1em; }
  #msg { flex:1; padding:0.5em; border-radius:8px; border:1px solid #ccc; }
  button { padding:0.5em 1em; background-color:#ff5a7e; border:none; border-radius:6px; color:white; cursor:pointer; }
  button:hover { background-color:#e04868; }
</style>
</head>
<body>

<header>Momo Talk</header>

<div class="panel">
  <label>‰Ω†ÁöÑ IDÔºö</label><span id="my-id">Áî¢Áîü‰∏≠...</span>
  <button onclick="copyId()">Ë§áË£Ω</button>
  <label style="margin-left:1em;">È†≠ÂÉèÔºö</label><input type="file" id="avatarInput" accept="image/*" />
</div>

<div id="chat"></div>

<div id="input-area">
  <input id="msg" placeholder="Ëº∏ÂÖ•Ë®äÊÅØÊàñÂúñÁâáÁ∂≤ÂùÄ..." />
  <input type="file" id="imgInput" accept="image/*" style="margin-left:5px;" />
  <button onclick="sendMsg()">ÂÇ≥ÈÄÅ</button>
  <button onclick="startRecording()">üéôÔ∏è</button>
  <button onclick="stopRecording()">‚èπÔ∏è</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const $ = id => document.getElementById(id);
let peer, conn, localAvatar = "", remoteAvatar = "", mediaRecorder, chunks = [];
const urlParams = new URLSearchParams(location.search);
const targetId = urlParams.get('id');

// Áî¢ÁîüÁü≠ID
function shortId() {
  return Math.random().toString(36).substr(2,5);
}

// ÂàùÂßãÂåñ Peer
function initPeer(id=null) {
  peer = new Peer(id || undefined, {
    debug: 2,
    config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }
  });

  peer.on('open', pid => {
    $("my-id").textContent = pid;
    if (!targetId) {
      console.log("Á≠âÂæÖÂà•‰∫∫Áî® ?id=" + pid + " ÈÄ£Á∑ö");
    } else {
      connectTo(targetId);
    }
  });

  peer.on("connection", c => {
    conn = c;
    setupConn();
    conn.on("open", () => {
      send({ type: "avatar", data: localAvatar });
    });
  });

  peer.on('error', err => {
    console.error(err);
    alert("PeerJS ÈåØË™§: " + err.type);
  });
}

function setupConn() {
  conn.on("data", handleData);
}

function connectTo(id) {
  conn = peer.connect(id);
  setupConn();
  conn.on("open", () => {
    send({ type: "avatar", data: localAvatar });
  });
}

function send(data) {
  if (conn && conn.open) conn.send(data);
}

function sendMsg() {
  const text = $("msg").value.trim();
  const file = $("imgInput").files[0];
  if (!text && !file) return;

  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      send({ type: "image", data: reader.result });
      addImage("me", reader.result);
    };
    reader.readAsDataURL(file);
    $("imgInput").value = "";
  } else {
    // ÂÅµÊ∏¨Á∂≤ÂùÄËΩâÈÄ£Áµê
    const html = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    send({ type: "text", data: html });
    addMessage("me", html);
    $("msg").value = "";
  }
}

function handleData(data) {
  if (data.type === "text") {
    addMessage("you", data.data);
  } else if (data.type === "avatar") {
    remoteAvatar = data.data;
  } else if (data.type === "audio") {
    const blob = new Blob([data.data], { type: 'audio/webm' });
    addAudio("you", URL.createObjectURL(blob));
  } else if (data.type === "image") {
    addImage("you", data.data);
  }
}

function addMessage(sender, html) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  msg.innerHTML = `
    <img class="avatar" src="${sender === 'me' ? localAvatar : remoteAvatar || 'https://via.placeholder.com/40'}" />
    <div class="bubble">${html}</div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function addImage(sender, src) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  msg.innerHTML = `
    <img class="avatar" src="${sender === 'me' ? localAvatar : remoteAvatar || 'https://via.placeholder.com/40'}" />
    <div class="bubble"><img src="${src}" style="max-width:200px; border-radius:8px;"></div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function addAudio(sender, url) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  msg.innerHTML = `
    <img class="avatar" src="${sender === 'me' ? localAvatar : remoteAvatar || 'https://via.placeholder.com/40'}" />
    <div class="bubble audio-bubble">
      <audio controls src="${url}"></audio>
    </div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function copyId() {
  navigator.clipboard.writeText($("my-id").textContent);
  alert("ID Â∑≤Ë§áË£Ω");
}

$("avatarInput").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = () => { localAvatar = reader.result; };
  if (e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
});

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    chunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      addAudio("me", URL.createObjectURL(blob));
      blob.arrayBuffer().then(buf => send({ type: "audio", data: buf }));
    };
    mediaRecorder.start();
  } catch (err) {
    alert("ÁÑ°Ê≥ïÈåÑÈü≥Ôºö" + err.message);
  }
}

function stopRecording() {
  if (mediaRecorder) mediaRecorder.stop();
}

// ÂïüÂãï
if (!targetId) {
  initPeer(shortId());
} else {
  initPeer();
}
</script>
</body>
</html>

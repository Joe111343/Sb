<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ¡ƒä¿¡ Momo Talk</title>
<style>
  body { font-family: "Segoe UI","Microsoft JhengHei",sans-serif; margin:0; background:#fffafc; display:flex; flex-direction:column; height:100vh; }
  header { background:#ff5a7e; color:#fff; padding:1em; text-align:center; font-weight:bold; font-size:1.3em; box-shadow:0 2px 4px #e47; }
  .panel { padding:0.5em 1em; background:#fff; border-radius:8px; margin:0.5em; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  #chat { flex:1; padding:1em; overflow-y:auto; display:flex; flex-direction:column; }
  .message { display:flex; align-items:flex-start; margin:0.6em 0; }
  .message img { width:48px; height:48px; border-radius:50%; border:2px solid #ff8ca5; margin-right:0.5em; }
  .me { flex-direction:row-reverse; }
  .me img { margin-left:0.5em; margin-right:0; }
  .bubble { max-width:70%; padding:0.6em 1em; border-radius:1em; word-break:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .me .bubble { background:linear-gradient(to right,#ffbdd3,#ffdce7); margin-left:auto; }
  .you .bubble { background:#f1f1f1; }
  .audio-bubble { display:inline-block; }
  #input-area { display:flex; padding:0.5em; border-top:1px solid #ccc; background:#fff0f5; }
  #msg { flex:1; padding:0.5em; border-radius:8px; border:1px solid #ccc; }
  button { padding:0.5em 1em; background-color:#ff5a7e; border:none; border-radius:6px; color:white; cursor:pointer; margin-left:0.3em; }
  button:hover { background-color:#e04868; }
</style>
</head>
<body>

<header>ğŸ‘ æ¡ƒä¿¡ Momo Talk</header>

<div class="panel">
  <div>ä½ çš„ IDï¼š<span id="my-id">ç”¢ç”Ÿä¸­...</span> <button onclick="copyId()">è¤‡è£½</button></div>
  <div>ç‹€æ…‹ï¼š<span id="status">æœªé€£ç·š</span></div>
  <div>é ­åƒï¼š<input type="file" id="avatarInput" accept="image/*"></div>
</div>

<div class="panel" id="manualConnect">
  <input id="peer-id" placeholder="è¼¸å…¥å°æ–¹ ID">
  <button onclick="connect()">é€£ç·š</button>
</div>

<div id="chat"></div>

<div id="input-area">
  <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." disabled />
  <button onclick="sendMsg()" disabled>å‚³é€</button>
  <button onclick="startRecording()" disabled>ğŸ™ï¸</button>
  <button onclick="stopRecording()" disabled>â¹ï¸</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
function randomRoomId() {
  return Math.floor(Math.random() * 9000 + 1000).toString(); // 1000~9999
}

const ROOM_ID = randomRoomId();
const peer = new Peer(ROOM_ID);

let conn = null;
let mediaRecorder, chunks = [];
let localAvatar = 'https://via.placeholder.com/40?text=æˆ‘';
let remoteAvatar = 'https://via.placeholder.com/40?text=ä»–';

const $ = id => document.getElementById(id);

peer.on('open', id => {
  $("my-id").textContent = id;
});

peer.on("connection", c => {
  conn = c;
  setupConn();
});

function connect() {
  const id = $("peer-id").value.trim();
  if (!id) return alert("è«‹è¼¸å…¥å°æ–¹ID");
  if (conn && conn.open) conn.close();
  conn = peer.connect(id);
  conn.on("open", () => {
    setupConn();
  });
  conn.on("error", err => {
    alert("é€£ç·šéŒ¯èª¤ï¼š" + err);
  });
}

function setupConn() {
  $("status").textContent = "å·²é€£ç·š: " + conn.peer;
  enableChat(true);
  if (localAvatar) send({ type: "avatar", data: localAvatar });
  conn.on("data", handleData);
  conn.on("close", () => {
    $("status").textContent = "é€£ç·šå·²ä¸­æ–·";
    enableChat(false);
  });
}

function enableChat(enabled) {
  $("msg").disabled = !enabled;
  $("msg").focus();
  document.querySelector("#input-area button[onclick='sendMsg()']").disabled = !enabled;
  document.querySelector("#input-area button[onclick='startRecording()']").disabled = !enabled;
  document.querySelector("#input-area button[onclick='stopRecording()']").disabled = !enabled;
}

$("avatarInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    localAvatar = reader.result;
    if (conn && conn.open) send({ type: "avatar", data: localAvatar });
  };
  reader.readAsDataURL(file);
});

function send(data) { if (conn && conn.open) conn.send(data); }

function sendMsg() {
  let text = $("msg").value.trim();
  if (!text) return;
  send({ type: "text", data: text });
  addMessage("me", formatMsg(text));
  $("msg").value = "";
}

function formatMsg(text) {
  const urlPattern = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlPattern, url => {
    if (/\.(jpg|jpeg|png|gif|webp)$/i.test(url)) {
      return `<img src="${url}" style="max-width:200px;max-height:200px;border-radius:8px;">`;
    } else {
      return `<a href="${url}" target="_blank">${url}</a>`;
    }
  });
}

function handleData(data) {
  if (data.type === "text") {
    addMessage("you", formatMsg(data.data));
  } else if (data.type === "avatar") {
    remoteAvatar = data.data;
  } else if (data.type === "audio") {
    const blob = new Blob([data.data], { type: "audio/webm" });
    addAudio("you", URL.createObjectURL(blob));
  }
}

function addMessage(sender, html) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  const avatarSrc = sender === 'me' ? localAvatar : remoteAvatar;
  msg.innerHTML = `<img src="${avatarSrc}" alt="avatar"><div class="bubble">${html}</div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function addAudio(sender, url) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  const avatarSrc = sender === 'me' ? localAvatar : remoteAvatar;
  msg.innerHTML = `<img src="${avatarSrc}" alt="avatar"><div class="bubble audio-bubble"><audio controls src="${url}"></audio></div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function copyId() {
  navigator.clipboard.writeText($("my-id").textContent);
  alert("ID å·²è¤‡è£½");
}

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    chunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      addAudio("me", URL.createObjectURL(blob));
      blob.arrayBuffer().then(buf => send({ type: "audio", data: buf }));
    };
    mediaRecorder.start();
  } catch (err) {
    alert("ç„¡æ³•éŒ„éŸ³ï¼š" + err.message);
  }
}

function stopRecording() {
  if (mediaRecorder) mediaRecorder.stop();
}
</script>

</body>
</html>

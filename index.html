<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>桃信 Momo Talk 自動+手動連線</title>
<style>
  body { font-family:"Segoe UI","Microsoft JhengHei",sans-serif; margin:0; background:linear-gradient(to bottom,#ffeef3,#fff); display:flex; flex-direction:column; height:100vh; }
  header { background:#ff5a7e; color:white; padding:1em; text-align:center; font-weight:bold; font-size:1.3em; letter-spacing:1px; box-shadow:0 2px 4px #e47; }
  .panel { padding:1em; background:#fff; border-radius:12px; margin:1em; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  #chat { flex:1; padding:1em; overflow-y:auto; background:#fffafc; display:flex; flex-direction:column; }
  .message { display:flex; align-items:flex-start; margin:0.6em 0; }
  .message img { width:48px; height:48px; border-radius:50%; border:2px solid #ff8ca5; margin-right:0.5em; }
  .bubble { max-width:70%; padding:0.6em 1em; border-radius:1em; word-break:break-word; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .me { flex-direction:row-reverse; }
  .me img { margin-left:0.5em; margin-right:0; }
  .me .bubble { background:linear-gradient(to right,#ffbdd3,#ffdce7); margin-left:auto; }
  .you .bubble { background:#f1f1f1; }
  .audio-bubble { display:inline-block; }
  #input-area { display:flex; padding:1em; border-top:1px solid #ccc; background:#fff0f5; }
  input,button { font-size:1em; }
  #msg { flex:1; padding:0.5em; border-radius:8px; border:1px solid #ccc; }
  button { padding:0.5em 1em; background:#ff5a7e; border:none; border-radius:6px; color:white; cursor:pointer; }
  button:hover { background:#e04868; }
  #manual-connect { margin-top:1em; }
  #status { margin-left:1em; font-weight:bold; }
</style>
</head>
<body>

<header>🍑 桃信 Momo Talk</header>

<div class="panel">
  <label>我的 ID：</label><span id="my-id">連線中...</span>
  <label style="margin-left:1em;">頭像：</label><input type="file" id="avatarInput" accept="image/*" />
</div>

<div class="panel" id="manual-connect" style="display:none;">
  <label>輸入對方 ID：</label>
  <input id="peer-id" placeholder="請輸入對方ID" />
  <button onclick="manualConnect()">手動連線</button>
  <span id="status"></span>
</div>

<div id="chat"></div>

<div id="input-area">
  <input id="msg" placeholder="輸入訊息或貼上連結/圖片網址..." />
  <button onclick="sendMsg()">傳送</button>
  <button onclick="startRecording()">🎙️</button>
  <button onclick="stopRecording()">⏹️</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const ROOM_ID = "1234";
const $ = id => document.getElementById(id);

let peer, conn;
let localAvatar = "", remoteAvatar = "";
let mediaRecorder, chunks = [];

function initPeer() {
  peer = new Peer(ROOM_ID, {
    debug: 2,
    config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }
  });

  peer.on("open", id => {
    $("my-id").textContent = id;
    tryAutoConnect();
  });

  peer.on("error", err => {
    console.warn("Peer錯誤:", err);
    if (err.type === "unavailable-id") {
      // 房間ID被用，改成自動生成ID，改成手動連線
      peer = new Peer();
      peer.on("open", id => {
        $("my-id").textContent = id;
        $("manual-connect").style.display = "block";
        $("status").textContent = "請輸入對方ID手動連線";
      });
    }
  });

  peer.on("connection", c => {
    conn = c;
    setupConn();
  });
}

function tryAutoConnect() {
  // 嘗試連線到 ROOM_ID 除非自己就是ROOM_ID
  if (peer.id === ROOM_ID) {
    // 房主，等人連線
    $("manual-connect").style.display = "none";
    $("status").textContent = "等待對方連線...";
  } else {
    // 嘗試連線到 ROOM_ID
    conn = peer.connect(ROOM_ID);
    setupConn();
    $("manual-connect").style.display = "none";
    $("status").textContent = "嘗試自動連線到房主...";
  }
}

function setupConn() {
  conn.on("open", () => {
    send({ type: "avatar", data: localAvatar });
    $("status").textContent = "已連線: " + conn.peer;
  });
  conn.on("data", handleData);
  conn.on("close", () => {
    $("status").textContent = "連線已中斷";
    conn = null;
  });
  conn.on("error", e => {
    $("status").textContent = "連線錯誤: " + e;
    conn = null;
  });
}

function manualConnect() {
  const id = $("peer-id").value.trim();
  if (!id) return alert("請輸入對方 ID");
  if (conn) conn.close();
  conn = peer.connect(id);
  setupConn();
  $("status").textContent = "嘗試手動連線...";
}

function send(data) {
  if (conn && conn.open) conn.send(data);
}

function sendMsg() {
  const text = $("msg").value.trim();
  if (!text) return;
  send({ type: "text", data: text });
  addMessage("me", formatMsg(text));
  $("msg").value = "";
}

function handleData(data) {
  if (data.type === "text") {
    addMessage("you", formatMsg(data.data));
  } else if (data.type === "avatar") {
    remoteAvatar = data.data;
  } else if (data.type === "audio") {
    const blob = new Blob([data.data], { type: "audio/webm" });
    addAudio("you", URL.createObjectURL(blob));
  }
}

function formatMsg(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, url => {
    if (/\.(jpg|jpeg|png|gif|webp)$/i.test(url)) {
      return `<br><img src="${url}" style="max-width:200px;border-radius:8px">`;
    }
    return `<a href="${url}" target="_blank">${url}</a>`;
  });
}

function addMessage(sender, html) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  msg.innerHTML = `
    <img src="${sender === 'me' ? localAvatar : remoteAvatar || 'https://via.placeholder.com/40'}">
    <div class="bubble">${html}</div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function addAudio(sender, url) {
  const msg = document.createElement("div");
  msg.className = `message ${sender}`;
  msg.innerHTML = `
    <img src="${sender === 'me' ? localAvatar : remoteAvatar || 'https://via.placeholder.com/40'}">
    <div class="bubble audio-bubble">
      <audio controls src="${url}"></audio>
    </div>`;
  $("chat").appendChild(msg);
  $("chat").scrollTop = $("chat").scrollHeight;
}

$("avatarInput").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = () => { localAvatar = reader.result; };
  if (e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
});

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    chunks = [];
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      addAudio("me", URL.createObjectURL(blob));
      blob.arrayBuffer().then(buf => send({ type: "audio", data: buf }));
    };
    mediaRecorder.start();
  } catch (err) {
    alert("無法錄音：" + err.message);
  }
}
function stopRecording() { if (mediaRecorder) mediaRecorder.stop(); }

initPeer();
</script>

</body>
</html>
